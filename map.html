<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Displacement Pathways</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --blue: #00aeef;
            --red: #e2231a;
            --yellow: #ffb500;
            --bg: #f4f7f6;
            --purple: #8e44ad;
            --panel-width: 360px;
        }

        body {
            margin: 0;
            background-color: var(--bg);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        /* --- VIEWPORT & CANVAS --- */
        #viewport {
            width: 100%;
            height: 100%;
            cursor: grab;
            position: relative;
            overflow: hidden;
        }
        #viewport:active { cursor: grabbing; }

        #transform-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            will-change: transform;
        }

        /* --- SVG LAYER --- */
        #svg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: visible;
        }

        .edge {
            fill: none;
            stroke: #a0aec0;
            stroke-width: 2px;
            stroke-linejoin: round;
            stroke-linecap: round;
            transition: stroke 0.3s;
        }

        .edge.dotted { stroke-dasharray: 6, 4; }

        /* --- NODES --- */
        .node {
            position: absolute;
            width: 180px;
            padding: 12px 15px;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
            cursor: pointer;
            z-index: 1;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 54px;
            box-sizing: border-box;
            background: #fff;
        }

        .node:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.12);
            z-index: 10;
        }

        .node.blue { background: linear-gradient(135deg, #00aeef, #0090c5); }
        .node.red { background: linear-gradient(135deg, #e2231a, #bd1c14); }
        .node.yellow { 
            background: linear-gradient(135deg, #ffb500, #e0a000); 
            color: #1a202c; 
        }
        .node.purple { background: linear-gradient(135deg, #8e44ad, #732d91); }
        
        .node.wide { width: 400px; }

        /* --- CONTROLS --- */
        .controls {
            position: fixed;
            bottom: 30px;
            left: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 90;
        }
        .btn {
            width: 44px; height: 44px;
            border-radius: 50%;
            border: none;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 16px;
            color: #4a5568;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn:hover { background: #edf2f7; transform: scale(1.1); }

        /* --- PANEL --- */
        .panel {
            position: fixed;
            right: 0;
            top: 0;
            width: var(--panel-width);
            height: 100%;
            background: white;
            box-shadow: -5px 0 30px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 200;
            display: flex;
            flex-direction: column;
        }
        .panel.open { transform: translateX(0); }

        @media (max-width: 768px) {
            .panel {
                top: auto;
                bottom: 0;
                width: 100%;
                height: 60vh;
                transform: translateY(100%);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
            }
            .panel.open { transform: translateY(0); }
            .controls { bottom: 20px; left: 20px; flex-direction: row; }
        }

        .panel-header {
            padding: 25px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .panel-tag {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #64748b;
            font-weight: 800;
            background: #e2e8f0;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 12px;
        }

        .panel-title { margin: 0; color: #1e293b; font-size: 22px; line-height: 1.2; }
        .panel-body { padding: 25px; line-height: 1.6; color: #475569; overflow-y: auto; }
        
        .close-btn { 
            position: absolute; top: 20px; right: 20px; 
            background: #edf2f7; border: none; 
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #64748b;
        }
    </style>
</head>
<body>

<div id="viewport">
    <div id="transform-layer">
        <!-- SVG LAYER -->
        <svg id="svg-layer">
            <defs>
                <!-- Small, sharp arrow -->
                <marker id="arrow" markerWidth="5" markerHeight="5" refX="5" refY="2.5" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,5 L5,2.5 z" fill="#a0aec0" />
                </marker>
            </defs>
            <!-- Paths -->
        </svg>
        <!-- Nodes -->
        <div id="node-container"></div>
    </div>
</div>

<div class="controls">
    <button class="btn" onclick="zoom(1.2)"><i class="fas fa-plus"></i></button>
    <button class="btn" onclick="zoom(0.8)"><i class="fas fa-minus"></i></button>
    <button class="btn" onclick="fitToScreen()"><i class="fas fa-expand"></i></button>
</div>

<div id="sidePanel" class="panel">
    <button class="close-btn" onclick="closePanel()"><i class="fas fa-times"></i></button>
    <div class="panel-header">
        <span id="pTag" class="panel-tag">Tag</span>
        <h2 id="pTitle" class="panel-title">Title</h2>
    </div>
    <div class="panel-body">
        <p id="pDesc">Description text.</p>
    </div>
</div>

<script>
    /* --- DATA & LAYOUT --- */
    const nodes = [
        { id: 'n1', x: 700, y: 50,  w: 180, label: 'Pre-crisis life', type: 'blue', meta: { tag: 'Journey', desc: 'Normal Development Context <br><br> •Children in stable family/community settings <br><br> •Regular school attendance •Social connections and play for child growth <br><br> •Access to healthcare and social services as well as a safe environment (water, sanitation and heating)' } },
        { id: 'n2', x: 700, y: 180, w: 180, label: 'Conflict exposure', type: 'red', meta: { tag: 'High Risk Stage', desc: 'Conflict Exposure & Initial Trauma <br><br> Immediate Risks <br>• Direct exposure to violence and hostilities <br>• Explosive ordnance and drone attacks <br>• 3,798 educational institutions damaged and exacerbating learning loss <br>• 1,109km of water networks, 82 water pumping stations, 12 water treatment plants, and 327 km of sewage networks damaged or destroyed <br>• Acute psychological trauma and fear with <br>• Learning loss and falling behind from expected learning level <br><br> Critical Needs<br>• Immediate physical safety<br>• Psychosocial first aid <br>• Age-appropriate crisis information<br>•Access to safe learning /catchup learning <br>• Safe water and heating<br>• Safe medical and health care<br><br>Prevention & Early Response Interventions Advocacy and Joint Prevention Plan <br>•End attacks on civilian infrastructure (3,798 schools damaged)<br>• Cease use of explosive weapons in populated areas<br>• Avoid impact on caused through damage of educational facilities and health facilities<br>• Educational Continuity<br>• Safe learning spaces in conflict-affected areas<br>• Mobile education services<br>• Psychosocial support integrated in schools and' } },
        { id: 'n3', x: 700, y: 310, w: 180, label: 'Evacuation', type: 'yellow', meta: { tag: 'Decision Point', desc: 'Evacuation Decision Point<br><br>Key Factors<br>• Mandatory evacuation orders issued<br>• Family capacity for self-organized movement including funds<br>• Availability of transportation<br>• Destination options (including availability of humanitarian assistance) and support networks<br><br>Child-Specific Considerations<br>• Separation from caregivers during evacuation<br>• Special needs for children with disabilities<br>• Comfort items and continuity needs<br>• Separation from learning peers and familiar teachers' } },
        
        { id: 'n4', x: 200, y: 440, w: 180, label: 'Occupied Territories', type: 'purple', meta: { tag: 'OT/RF', desc: 'Children in Occupied Territories/Russian Federation <br><br> Grave Violations<br>• Documented cases of transfer of Ukrainian children to Russia, including change in names and nationality<br>• Challenging tracing and family reunification<br>• Cases child recruitment through online content with recruitment propaganda<br>• Limited humanitarian access <br><br> Humanitarian challenges<br>• Exposure to explosive weapons,<br>displacement<br>• Water crisis, lack of access to health,<br>education<br>• High risk of outbreaks, infection diseases, waterborne diseases' } },


        { id: 'n5', x: 450, y: 440, w: 180, label: 'Frontline children', type: 'red', meta: { tag: 'High Risk Stage', desc: 'Children Remaining in Frontline Areas<br><br>Hidden Population<br>• Families deliberately hide children from evacuation orders<br>• Children not visible (invisible children) in official evacuation data<br>• Family returning to frontlines after evacuation due to lack of support<br>• Self-imposed confinement due to security risks<br><br>Extreme Risks<br>• Constant exposure to drones and shelling<br>• Limited access to education, healthcare, social services, basic needs <br><br><br> Humanitarian Access<br>• Negotiate safe humanitarian corridors <br><br> Return and Reintegration<br>• Cross Border Family reunification<br>• Reintegration assistance in Ukraine<br><br>Monitoring and Reporting (CAAC)<br><br>Humanitarian assistance<br>• MHPSS, case management, EORE<br>• Access to health, water,' } },
        
        { id: 'n6', x: 950, y: 440, w: 180, label: 'Evacuation Process', type: 'blue', meta: { tag: 'Journey', desc: 'Evacuation Implementation<br><br>Process Types<br>•Evacuations conducted by humanitarian actors and<br>State actors<br>•Organized evacuations through transit centers<br>•Self-managed family evacuations<br>•Emergency evacuations during active hostilities<br><br><br>Child-Friendly Evacuation Support <br><br>• Keeping Families Together<br>• Prevent family separation during evacuation<br>• Joint evacuation planning for families<br>• Social workforce engaged and supported at different points of journey<br><br>Specialized Support<br>• Accessible transport for children with disabilities<br>• Emergency care arrangements for unaccompanied children<br><br>Child Protection Measures<br>• Family tracing during evacuation<br>• Special transport for children with disabilities<br>• Child-friendly evacuation procedures<br>• Provision of MPCA for families with children<br>• Age-appropriate evacuation information<br>• Comfort items and continuity planning<br>• Immediate protection screening and Case management' } },
        
        { id: 'n7', x: 1250, y: 500, w: 180, label: 'Family separation', type: 'red', meta: { tag: 'High Risk Stage', desc: 'Family Separation Crisis<br><br>Separation Scenarios<br>• 36% of households report family separation<br>• Caregivers sending children to safer areas ahead<br>• Fathers unable to evacuate due to conscription<br>rules<br>• Children placed with temporary caregivers<br>Protection Risks<br>• Increased vulnerability to violence, abuse, neglect<br>• Psychological distress from separation<br>• Risk of trafficking and exploitation<br>• Challenges in family reunification<br><br> Family Tracing & Reunification <br> Tracing Services<br>• Activate family tracing network<br><br>Reunification Support<br>• Safe transport for reunification<br>• Family assessment and support<br>• Post-reunification monitoring<br><br>Communication Services<br>• Free communication platforms for families<br>• Message relay services<br>• Regular contact facilitation'} },
        { id: 'n8', x: 1450, y: 620, w: 180, label: 'Institutional Care', type: 'red', meta: { tag: 'High Risk Stage', desc: 'Children in Institutional Care<br><br>Current Scale<br>• 26,000 children live in 720 institutions<br>• Over 2,000 children from institutions evacuated<br>• 3,188 children returned to Ukraine from abroad<br>• 1,047 returned to residential care (not families)<br><br>System Challenges<br>• War is institutionalizing more children<br>• Overreliance on institutional vs family-based care<br>• Absence of sufficient foster families<br>• Risk of prolonged institutionalization' } },

        { id: 'n9', x: 780, y: 570, w: 180, label: 'Transit Centers', type: 'blue', meta: { tag: 'Journey', desc: 'Current Situation<br>•17.7% of residents are children<br>• Overcrowded conditions in many sites<br>• Only 25% have disability-friendly facilities<br>• Limited child-friendly spaces<br>• Inadequate WASH facilities in some sites (and risk of infectious diseases)<br><br>Immediate Needs<br>• Safe spaces for play and learning<br>• Family tracing and communication<br>• Psychosocial support and counseling<br>• Child protection case management<br>• Cash assistance for families with children<br>• WASH facilities in transit and collective centers<br>• Hygiene items' } },


        { id: 'n10', x: 1120, y: 570, w: 180, label: 'Community Living', type: 'blue', meta: { tag: 'Journey', desc: 'Living Situation<br>•85% of evacuees move to community settings<br>•60% of IDPs have rental costs in monthly expenses<br>•31% spend over 70% of income on housing<br>•Many live without formal rental agreements<br><br>Integration Challenges<br>• Fear of eviction and housing insecurity<br>• Access to offline education and quality healthcare<br>• Social integration and peer relationships<br>• Economic pressure on families' } },

        { id: 'n11', x: 780, y: 700, w: 180, label: 'Collective sites', type: 'red', meta: { tag: 'Shelter', desc: 'Long-term Challenges<br>• 81% of residents displaced for 18+ months<br>• 88% indicate intention to remain<br>•72% cite housing affordability as barrier to leaving<br>• Poor living conditions and limited privacy<br><br>Child-Specific Risks<br>• Exposure to unsafe, overcrowded conditions with high risk of disease outbreaks<br>• Limited access to child-friendly services including health care<br>• Educational disruption and social isolation – 45% of parents indicate negative consequences of displacement on their children’s education<br>• Increased risk of violence and exploitation<br><br>Community Integration Support<br><br>Housing and Cash Assistance<br>• Multipurpose cash assistance<br>• Legal aid support for families, including against eviction<br><br>Educational Continuity<br>• School enrollment support<br>• Catch-up/remedial education programs<br>• Language and integration support<br><br>Social Inclusion<br>• Community integration activities<br>• Peer support networks for children<br><br>Economic Support<br>• Family livelihood programs<br>• Positive Parenting and Skills training for parents<br>• Child care support for working parents' } },
        
        
        { id: 'n12', x: 700, y: 830, w: 400, label: 'Protracted displacement', type: 'red', className: 'wide', meta: { tag: 'Phase 3', desc: 'Long-term Displacement Impacts<br><br>Mental Health Crisis<br>• 43% of children in programs show psychosocial distress<br>• 1.5 million children at risk of depression/PTSD<br>• 1 in 5 children lost a close relative or friend<br>• 84% of households identify distress as overwhelming risk<br><br>Emerging Threats<br>• Online recruitment and exploitation<br>• Russian Federation grooming children via social media<br>• 4,476 children victims of crimes (Jan-July 2025)<br>• Justice system treating children punitively vs protectively<br>• 70% face acute material deprivation<br><br>Educational Impact<br>• 1.2 million children missing full-time learning<br>• 65% of frontline children in online schooling<br>• Digital divide affecting access<br><br>Sexual Exploitation & Trafficking<br>• 76% of trafficking cases involve labor exploitation<br>• Risk of trafficking for sexual exploitation documented<br>• Economic desperation increasing survival sex risks<br>• Vulnerability along evacuation routes<br><br>Technology-Facilitated Violence<br>• Online grooming and sexual exploitation<br>• Digital harassment and abuse<br>• Unsupervised online learning increasing exposure<br>• Recruitment through social media platforms<br><br>Movement & Safety Restrictions<br>• Women and girls feel less safe outside home<br>• Absence of public street lighting restricts movement<br>• Collective housing creating vulnerabilities<br>• Risk from substance abuse in communities<br><br>Mental Health & Psychosocial Support<br>Community-Based and Family Support<br>• Peer support groups for children and adolescents<br>• Resilience Services, including positive parenting<br>• Individual and group therapy and counseling<br>• Support groups for displaced families<br><br>Child-Friendly Justice<br>Victim-Centered Approach<br>• Treat recruited children as victims, not criminals<br>• Free specialized legal aid for children<br>• Child-sensitive court procedures<br>• Protection from harsh punishments for recruited children<br>• Alternatives to Detention<br>• Reintegration Support<br><br>Learning Recovery<br>• Catch up/remedial education<br>• Ensuring availability of inclusive education<br><br>School-Based MHPSS Services<br>• School counselors and psychologists<br>• Teacher training on trauma-informed approaches<br>• Classroom-based social-emotional learning<br><br>Girls-Focused Protection Interventions<br>GBV Prevention & Response<br>• Specialized GBV case management<br>• Legal aid and justice support<br>• Safe reporting mechanisms<br>• Survivor-centered services'} },
        
        { id: 'n13', x: 500, y: 960, w: 180, label: 'Post-displacement', type: 'yellow', meta: { tag: 'Phase 4', desc: 'Pathways towards durable solutions.' } },
        
        { id: 'n14', x: 200, y: 1090, w: 180, label: 'Return to Risk', type: 'red', meta: { tag: 'Outcome', desc: 'Return to Unsafe Areas<br><br>Return Motivations<br>• 18% return due to inability to earn income in displacement<br>• 25% cite lack of affordable housing<br>• Family reunification needs<br>• Property monitoring and asset protection<br><br>Child-Specific Risks<br>• Re-exposure to active hostilities<br>• Limited access to education and healthcare<br>• Family separation if women return alone<br>• Continued trauma and stress' } },
        { id: 'n15', x: 800, y: 1090, w: 180, label: 'Local integration', type: 'blue', meta: { tag: 'Outcome', desc: 'Successful Local Integration<br><br>Positive Outcomes<br>• Stable housing and community connections<br>• Access to quality education and healthcare, safe water & sanitation, and heating<br>• Enrollment in social protection schemes, as relevant<br>• Social integration and peer relationships<br>• Economic stability for families<br><br>Success Factors<br>• Strong community support systems<br>• Adequate and affordable housing<br>• Quality social services<br>• Educational continuity and support' } },
    ];

    const connections = [
        { from: 'n1', to: 'n2', type: 'straight' },
        { from: 'n2', to: 'n3', type: 'straight' },
        { from: 'n3', to: 'n4', type: 'fork-left-far' },
        { from: 'n3', to: 'n5', type: 'fork-left-near' },
        { from: 'n3', to: 'n6', type: 'fork-right-near' },
        { from: 'n6', to: 'n9', type: 'fork-down-left' },
        { from: 'n6', to: 'n10', type: 'fork-down-right' },
        { from: 'n6', to: 'n7', type: 'side-dotted' },
        { from: 'n7', to: 'n8', type: 'side-dotted-down' },
        { from: 'n9', to: 'n11', type: 'straight' },
        { from: 'n10', to: 'n12', type: 'ortho-deep' }, 
        { from: 'n11', to: 'n12', type: 'elbow-in' },
        { from: 'n12', to: 'n13', type: 'elbow-left-step' },
        { from: 'n13', to: 'n14', type: 'fork-left-btm' },
        { from: 'n13', to: 'n15', type: 'fork-right-btm' }
    ];

    // --- RENDER ENGINE ---
    const container = document.getElementById('node-container');
    const svg = document.getElementById('svg-layer');

    // Create Nodes
    nodes.forEach(n => {
        const el = document.createElement('div');
        el.className = `node ${n.type} ${n.className || ''}`;
        el.style.left = n.x + 'px';
        el.style.top = n.y + 'px';
        el.style.width = n.w + 'px';
        el.textContent = n.label;
        
        const activate = (e) => {
            e.stopPropagation();
            openPanel(n);
        };
        el.addEventListener('click', activate);
        el.addEventListener('touchstart', activate, {passive: true});

        container.appendChild(el);
    });

    // Create Connectors
    connections.forEach(conn => {
        const start = nodes.find(n => n.id === conn.from);
        const end = nodes.find(n => n.id === conn.to);

        const startX = start.x + (start.w) / 2;
        const startY = start.y + 54; 
        
        const endX = end.x + (end.w) / 2;
        const endY = end.y; 

        let d = '';

        if (conn.type === 'straight') {
            d = `M ${startX} ${startY} L ${endX} ${endY - 6}`;
        }
        else if (conn.type.includes('fork-left')) {
            const midY = startY + 25;
            d = `M ${startX} ${startY} L ${startX} ${midY} L ${endX} ${midY} L ${endX} ${endY - 6}`;
        }
        else if (conn.type.includes('fork-right')) {
            const midY = startY + 25;
            d = `M ${startX} ${startY} L ${startX} ${midY} L ${endX} ${midY} L ${endX} ${endY - 6}`;
        }
        else if (conn.type === 'fork-down-left') {
            const midY = endY - 25;
            d = `M ${startX} ${startY} L ${startX} ${midY} L ${endX} ${midY} L ${endX} ${endY - 6}`;
        }
        else if (conn.type === 'fork-down-right') {
            const midY = endY - 25;
            d = `M ${startX} ${startY} L ${startX} ${midY} L ${endX} ${midY} L ${endX} ${endY - 6}`;
        }
        else if (conn.type === 'ortho-deep') {
            const deepY = 790; 
            d = `M ${startX} ${startY} L ${startX} ${deepY} L ${endX + 80} ${deepY} L ${endX + 80} ${endY - 6}`; 
        }
        else if (conn.type === 'elbow-in') {
            const midY = (startY + endY)/2;
            d = `M ${startX} ${startY} L ${startX} ${midY} L ${endX} ${midY} L ${endX} ${endY - 6}`;
        }
        else if (conn.type === 'elbow-left-step') {
            d = `M ${startX} ${startY} L ${startX} ${endY - 25} L ${endX} ${endY - 25} L ${endX} ${endY - 6}`;
        }
        else if (conn.type === 'side-dotted') {
            const sRx = start.x + start.w;
            const sRy = start.y + 27;
            const eLx = end.x;
            const eLy = end.y + 27;
            d = `M ${sRx} ${sRy} C ${sRx+50} ${sRy}, ${eLx-50} ${eLy}, ${eLx - 6} ${eLy}`;
        }
        else if (conn.type === 'side-dotted-down') {
            const sRx = start.x + start.w;
            const sRy = start.y + 27;
            const eLx = end.x;
            const eLy = end.y + 27;
            d = `M ${sRx} ${sRy} L ${eLx - 30} ${sRy} L ${eLx - 30} ${eLy} L ${eLx - 6} ${eLy}`;
        }
        else if (conn.type === 'fork-left-btm') {
            const midY = endY - 25;
            d = `M ${startX} ${startY} L ${startX} ${midY} L ${endX} ${midY} L ${endX} ${endY - 6}`;
        }
        else if (conn.type === 'fork-right-btm') {
            const midY = endY - 25;
            d = `M ${startX} ${startY} L ${startX} ${midY} L ${endX} ${midY} L ${endX} ${endY - 6}`;
        }

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", d);
        path.setAttribute("class", "edge " + (conn.type.includes('dotted') ? "dotted" : ""));
        path.setAttribute("marker-end", "url(#arrow)");
        svg.appendChild(path);
    });

    // --- PAN & ZOOM LOGIC ---
    let scale = 1;
    let pX = 0, pY = 0;
    const layer = document.getElementById('transform-layer');
    const viewport = document.getElementById('viewport');

    let isDragging = false;
    let startX = 0, startY = 0;

    function updateTransform() {
        layer.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`;
    }

    // Auto-fit function
    function fitToScreen() {
        // Find bounds of all nodes
        let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
        nodes.forEach(n => {
            if(n.x < minX) minX = n.x;
            if(n.x + n.w > maxX) maxX = n.x + n.w;
            if(n.y < minY) minY = n.y;
            if(n.y + 54 > maxY) maxY = n.y + 54;
        });

        // Add padding
        const padding = 50;
        const contentW = (maxX - minX) + (padding * 2);
        const contentH = (maxY - minY) + (padding * 2);
        
        const viewW = window.innerWidth;
        const viewH = window.innerHeight;

        // Calculate Scale to fit
        const scaleX = viewW / contentW;
        const scaleY = viewH / contentH;
        scale = Math.min(scaleX, scaleY, 1); // Max scale 1 to prevent zooming in too much on large screens

        // Calculate Position to center
        // Center of content in node coords
        const contentCenterX = minX + (maxX - minX) / 2;
        const contentCenterY = minY + (maxY - minY) / 2;

        pX = (viewW / 2) - (contentCenterX * scale);
        pY = (viewH / 2) - (contentCenterY * scale);

        updateTransform();
    }

    // Mouse Events
    viewport.addEventListener('mousedown', e => {
        isDragging = true;
        startX = e.clientX - pX;
        startY = e.clientY - pY;
    });
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('mousemove', e => {
        if (!isDragging) return;
        e.preventDefault();
        pX = e.clientX - startX;
        pY = e.clientY - startY;
        updateTransform();
    });

    // Touch Events
    viewport.addEventListener('touchstart', e => {
        if(e.touches.length === 1) {
            isDragging = true;
            startX = e.touches[0].clientX - pX;
            startY = e.touches[0].clientY - pY;
        }
    }, {passive: false});
    
    window.addEventListener('touchend', () => isDragging = false);
    
    window.addEventListener('touchmove', e => {
        if (!isDragging) return;
        e.preventDefault(); 
        pX = e.touches[0].clientX - startX;
        pY = e.touches[0].clientY - startY;
        updateTransform();
    }, {passive: false});

    window.zoom = (factor) => {
        scale *= factor;
        scale = Math.min(Math.max(0.3, scale), 2);
        updateTransform();
    };
    
    window.resetZoom = fitToScreen;

    // --- PANEL LOGIC ---
    function openPanel(data) {
        document.getElementById('pTitle').innerHTML = data.label;
        document.getElementById('pTag').innerHTML = data.meta.tag;
        document.getElementById('pDesc').innerHTML = data.meta.desc;
        
        const tag = document.getElementById('pTag');
        if(data.type === 'blue') { tag.style.color = '#00aeef'; tag.style.background = '#e0f7ff'; }
        else if(data.type === 'red') { tag.style.color = '#e2231a'; tag.style.background = '#ffe5e5'; }
        else { tag.style.color = '#d69e00'; tag.style.background = '#fff8dc';}

        document.getElementById('sidePanel').classList.add('open');
    }

    window.closePanel = () => {
        document.getElementById('sidePanel').classList.remove('open');
    };

    // Initial Load
    window.onload = fitToScreen;
    window.onresize = fitToScreen;

</script>
</body>
</html>
